/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */

(function(o){typeof define==="function"?define([],o):typeof exports==="object"?o(require,exports):o(void 0,Q={})})(function(o,c){function C(a){return a}function u(a,b,d){a[b]||(a[b]=d);return a[b]}function p(a){return a===void 0||a===null?a:a.valueOf()}function g(){function a(a){if(b)return d=k(a),b.length===0&&v(d)&&D(d.valueOf().reason),w.call(b,function(a,b){l(function(){d.promiseSend.apply(d,b)})},void 0),b=void 0,d}var b=[],d,j=q(g.prototype),c=q(e.prototype);c.promiseSend=function(){var a=f.call(arguments);
b?b.push(a):l(function(){d.promiseSend.apply(d,a)})};c.valueOf=function(){return b?c:d.valueOf()};j.promise=y(c);j.resolve=a;j.reject=function(b){return a(h(b))};return j}function e(a,b,d){b===void 0&&(b=function(a){return h("Promise does not support operation: "+a)});var j=q(e.prototype);j.promiseSend=function(d,c){var n=f.call(arguments,2),x;try{x=a[d]?a[d].apply(j,n):b.apply(j,[d].concat(n))}catch(e){x=h(e)}return(c||C)(x)};if(d)j.valueOf=d;return y(j)}function t(a){return a&&typeof a.promiseSend===
"function"}function v(a){a=p(a);return a===void 0||a===null?!1:!!a.promiseRejected}function h(a){var b=e({when:function(d){if(d){var b=z.indexOf(this);b!==-1&&(A.splice(b,1),z.splice(b,1))}return d?d(a):h(a)}},function(){return h(a)},function(){var b=q(h.prototype);b.promiseRejected=!0;b.reason=a;return b});z.push(b);A.push(a);return b}function k(a){if(t(a))return a;if(a&&typeof a.then==="function"){var b=g();a.then(b.resolve,b.reject);return b.promise}return e({when:function(){return a},get:function(b){return a[b]},
put:function(b,c){return a[b]=c},del:function(b){return delete a[b]},post:function(b,c){return a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},viewInfo:function(){function b(a){e[a]||(e[a]=typeof c[a])}for(var c=a,e={};c;)Object.getOwnPropertyNames(c).forEach(b),c=Object.getPrototypeOf(c);return{type:typeof a,properties:e}},keys:function(){return K(a)}},void 0,function(){return a})}function E(a,b){a=k(a);return b?e({viewInfo:function(){return b}},function(b){var c=f.call(arguments);return r.apply(void 0,
[a].concat(c))},function(){return p(a)}):r(a,"viewInfo")}function i(a,b,d){function c(a){try{return b?b(a):a}catch(d){return h(d)}}function e(a){try{return d?d(a):h(a)}catch(b){return h(b)}}var f=g(),n=!1;l(function(){k(a).promiseSend("when",function(a){n||(n=!0,f.resolve(k(a).promiseSend("when",c,e)))},function(a){n||(n=!0,f.resolve(e(a)))})});return f.promise}function m(a){return function(b){var d=f.call(arguments,1);return r.apply(void 0,[b,a].concat(d))}}function r(a,b){var d=g(),c=f.call(arguments,
2),a=k(a);l(function(){a.promiseSend.apply(a,[b,d.resolve].concat(c))});return d.promise}function F(a){if(arguments.length>1)var b=Array.prototype.slice.call(arguments,1),a=a.bind.apply(a,b);return function(){var b=g(),c=f.call(arguments);c.push(b.node());s(a,this,c).fail(b.reject);return b.promise}}var l;try{l=o("event-queue").enqueue}catch(L){if(typeof MessageChannel!=="undefined"){var G=new MessageChannel,B={},H=B;G.port1.onmessage=function(){var a=B.next,b=a.task;B=a;b()};l=function(a){H=H.next=
{task:a};G.port2.postMessage(0)}}else l=function(a){setTimeout(a,0)}}var y=u(Object,"freeze",C),q=u(Object,"create",function(a){function b(){}b.prototype=a;return new b}),K=u(Object,"keys",function(a){var b=[],d;for(d in a)b.push(d);return b}),w=Array.prototype.reduce||function(a,b){var d=0,c=this.length;if(arguments.length===1){do{if(d in this){b=this[d++];break}if(++d>=c)throw new TypeError;}while(1)}for(;d<c;d++)d in this&&(b=a(b,this[d],d));return b},f=Array.prototype.slice;c.nextTick=l;var D=
function(a){a instanceof Error?console.error("unhandledRejectionHandler",a.stack):console.warn("warning: rejection reached end of promise chain without being handled",a.toString())};c.setUnhandledRejectionHandler=function(a){D=a||function(){}};c.defer=g;g.prototype.node=function(){var a=this;return function(b,d){b?a.reject(b):arguments.length>2?a.resolve(Array.prototype.slice.call(arguments,1)):a.resolve(d)}};c.makePromise=e;e.prototype.then=function(a,b){return i(this,a,b)};w.call("isResolved,isFulfilled,isRejected,when,spread,send,get,put,del,post,invoke,keys,apply,call,bind,all,view,viewInfo,timeout,delay,fail,fin,end".split(","),
function(a,b){e.prototype[b]=function(){return c[b].apply(c,[this].concat(f.call(arguments)))}},void 0);e.prototype.toSource=function(){return this.toString()};e.prototype.toString=function(){return"[object Promise]"};y(e.prototype);c.isPromise=t;c.isResolved=function(a){return!t(p(a))};c.isFulfilled=function(a){return!t(p(a))&&!v(a)};c.isRejected=v;var z=[],A=[];typeof window!=="undefined"&&console.log("Should be empty:",A);c.reject=h;h.prototype=q(e.prototype,{constructor:{value:h}});c.resolve=
k;c.ref=k;c.master=function(a){return e({isDef:function(){}},function(b){var d=f.call(arguments);return r.apply(void 0,[a].concat(d))},function(){return p(a)})};c.viewInfo=E;c.view=function(a){return E(a).when(function(b){var d;d=b.type==="function"?function(){return s(a,void 0,arguments)}:{};var c=b.properties||{};Object.keys(c).forEach(function(b){c[b]==="function"&&(d[b]=function(){return I(a,b,arguments)})});return k(d)})};c.when=i;c.spread=function(a,b,d){return i(a,function(a){return b.apply(void 0,
a)},d)};c.async=function(a){return function(){function b(a,b){var f;try{f=d[a](b)}catch(g){return Object.prototype.toString.call(g)==="[object StopIteration]"?g.value:h(g)}return i(f,c,e)}var d=a.apply(this,arguments),c=b.bind(b,"send"),e=b.bind(b,"throw");return c()}};c.sender=m;c.Method=m;c.send=r;c.get=m("get");c.put=m("put");c.del=m("del");var I=c.post=m("post");c.invoke=function(a,b){var d=f.call(arguments,2);return I(a,b,d)};var s=c.apply=m("apply");c.call=function(a,b){var d=f.call(arguments,
2);return s(a,b,d)};c.bind=function(a,b){var d=f.call(arguments,2);return function J(){var c=d.concat(f.call(arguments));if(this instanceof J){var e=function(){};e.prototype=a.prototype;var g=new e;return s(a,g,c).then(function(a){return Object(a)===a?a:g})}else return s(a,b,c)}};c.keys=m("keys");c.all=function(a){return i(a,function(a){var c=a.length;if(c===0)return k(a);var e=g();w.call(a,function(f,g,h){i(g,function(f){a[h]=f;--c===0&&e.resolve(a)}).fail(e.reject)},void 0);return e.promise})};
c.fail=function(a,b){return i(a,void 0,b)};c.fin=function(a,b){return i(a,function(a){return i(b(),function(){return a})},function(a){return i(b(),function(){return h(a)})})};c.end=function(a){i(a,void 0,function(a){l(function(){throw a;})})};c.timeout=function(a,b){var c=g();i(a,c.resolve,c.reject);setTimeout(function(){c.reject("Timed out")},b);return c.promise};c.delay=function(a,b){b===void 0&&(b=a,a=void 0);var c=g();setTimeout(function(){c.resolve(a)},b);return c.promise};c.node=F;c.ncall=function(a,
b){var c=f.call(arguments,2);return F(a).apply(b,c)}});