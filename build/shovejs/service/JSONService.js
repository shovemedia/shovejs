define("require,shovejs/Context,shovejs/model/ClassRegistry,shovejs/model/ObjectRegistry,shovejs/service/ObjectIdentityService,lib/json2,lib/q,lib/signals".split(","),function(a){var l=a("shovejs/Context"),m=a("shovejs/model/ClassRegistry"),k=a("shovejs/model/ObjectRegistry"),n=a("shovejs/service/ObjectIdentityService"),h=a("lib/json2"),o=a("lib/q");a("lib/signals");var p=function(){},a=function(){};a.injectionFields={context:l,objectRegistry:k,objectIdentityService:n,classRegistry:m};a.prototype.toJSON=
function(b){if(this.metaData==null)console.log("new meta data object!"),this.metaData={};b=h.stringify(b,this.getDataReplacer(this.metaData),"  ");console.log("--");console.log("");console.log(b);console.log("");console.log("--");var d=h.stringify(this.metaData,this.getMetaReplacer(this.metaData),"  ");this.metaData=null;return'{"meta" :'+d+', "data" :'+b+"}"};a.prototype.fromJSON=function(b){var b=h.parse(b),d=new k,a;for(a in b.meta){var f=o.defer();d.registerModel(a,f)}for(var j=[],i=0,c=d.objectById.keys.length;i<
c;i++){a=d.objectById.keys[i];var f=b.meta[a],e=f.value,q=this.classRegistry.getClass(f.type),f=d.getObject(a);this.fillReferences(e,d);e=this.context.createNewInstance(q,e,!0);f.resolve(e);this.objectRegistry.registerModel(a,e);j.push(e)}this.fillReferences(j,this.objectRegistry);b.data=this.fillReferences(b.data,this.objectRegistry);return b.data};a.prototype.getDataReplacer=function(){var b=this;return function(d,a){console.log("getDataReplacer",d,a);return b.toJSONref(a)}};a.prototype.toJSONref=
function(b){console.log("JSONService.prototype.toJSONref",this.classRegistry,b);var a=!1;this.classRegistry.getId(b.constructor)&&(a=!0);console.log("auto id? ",a,"instance",b);a=this.objectIdentityService.get(b,a);return a!=void 0?(this.metaData[a]==void 0&&(this.metaData[a]=b,this.context.toJSON(b)),console.log("$ref",a),{$ref:a}):b};a.prototype.getMetaReplacer=function(b){var a=this.objectIdentityService,g=this.classRegistry,f=this.context,j=this;return function(i,c){console.log("meta key",i);
console.log("meta value",typeof c,c,"this:",this,"metaData:",b);var e=a.get(c);if(e!=void 0&&b[e]!=void 0)if(this==b){var e=g.getId(c.constructor),h=f.toJSON(c),c=new p;c.type=e;c.value=h}else c=j.toJSONref(c);return c}};a.prototype.fillReferences=function(a,d){if(a instanceof Object&&!this.context.factoryRegistry.get(a.constructor))if(a.hasOwnProperty("$ref"))a=d.getObject(a.$ref);else for(var g in a)a.hasOwnProperty(g)&&a[g]!=void 0&&(a[g]=this.fillReferences(a[g],d));return a};return a});