define("require,shovejs/model/ClassRegistry,shovejs/model/ObjectRegistry,shovejs/model/Dictionary,shovejs/Injector,shovejs/MediatorMap,lib/signals".split(","),function(d){var i=d("shovejs/model/ClassRegistry"),j=d("shovejs/model/ObjectRegistry"),e=d("shovejs/model/Dictionary"),k=d("shovejs/Injector"),l=d("shovejs/MediatorMap"),m=d("lib/signals"),d=function(){this.getInjector();this.factoryRegistry=new e;this.serviceRegistry=new e;this.classRegistry=new i;this.injector.mapValue(i,"classRegistry",this.classRegistry);
var a=new j;this.injector.mapValue(j,"objectRegistry",a);this.getViewMediatorMap();this.mediatorsByViewInstance=new e;this.viewInstanceByMediator=new e;this.viewClassByModelClass=new e;this.viewByModel=new e;this.controllerDataByView=new e;this.commandsBySignal=new e};d.prototype.getInjector=function(){if(this.injector==null)this.injector=new k;return this.injector};d.prototype.setInjector=function(a){this.injector=a};d.prototype.getViewMediatorMap=function(){if(this.viewMediatorMap==null)this.viewMediatorMap=
new l;return this.viewMediatorMap};d.prototype.setViewMediatorMap=function(a){this.viewMediatorMap=a};d.prototype.mapModelView=function(a,b,c){this.injector.mapInjectionFields(b);c?(this.viewClassByModelClass.get(a)||this.viewClassByModelClass.set(a,new e),this.viewClassByModelClass.get(a).set(c,b)):this.viewClassByModelClass.set(a,b)};d.prototype.unmapModelView=function(a,b,c){c?this.viewClassByModelClass.get(a)&&this.viewClassByModelClass.get(a).remove(c):this.viewClassByModelClass.remove(a)};d.prototype.registerClass=
function(a,b){this.classRegistry.registerClass(a,b)};d.prototype.registerFactory=function(a,b,c,d){this.injector.mapInjectionFields(a);this.injector.mapInjectionFields(b);c||(c=this.createNewInstance(b,null,!0));d&&this.injector.mapValue(b,d,c);this.factoryRegistry.set(a,c)};d.prototype.registerService=function(a,b,c){this.injector.mapInjectionFields(b);c||(c=this.createNewInstance(b,a,!0),console.log("registerService auto create",c));this.injector.mapValue(b,a,c);this.serviceRegistry.set(a,c)};d.prototype.registerModel=
function(a){if(!this.viewByModel.get(a)){console.log("registerModel",a);var b=this.viewClassByModelClass.get(a.constructor);if(b instanceof e){console.log("multi-context model -> view mapping");for(var c in b.keys){var d=b.keys[c];console.log("view context",d);var g=b.get(d);console.log("view class",g);this.instantiateView(a,g,d)}}else this.instantiateView(a,b)}};d.prototype.instantiateView=function(a,b,c){console.log("model");console.log(a);console.log("view class "+b);b=this.createNewInstance(b,
a,!0);this.injector.injectInto(b);console.log("view instance "+b);b.viewAddedSignal&&b.viewAddedSignal.add(this.registerView,this);b.viewRemovedSignal&&b.viewRemovedSignal.add(this.unregisterView,this);b.observe(a);c==null?this.viewByModel.set(a,b):(this.viewByModel.get(a)||this.viewByModel.set(a,new e),this.viewByModel.get(a).set(c,b))};d.prototype.getViewByModel=function(a,b){console.log("getViewByModel:");console.log("context:",b);console.log(a);this.viewByModel.get(a)||this.registerModel(a);return b==
null?this.viewByModel.get(a):this.viewByModel.get(a).get(b)};d.prototype.toJSON=function(a){var b=this.factoryRegistry.get(a.constructor);return b&&b.toJSON?b.toJSON(a):a};d.prototype.init=function(){console.log("serviceRegistry",this.serviceRegistry);var a=this.serviceRegistry.values,b;for(b in a){var c=a[b];console.log("service",b,c);this.injector.injectInto(c);c.init&&c.init()}a=this.factoryRegistry.values;for(b in a)c=a[b],this.injector.injectInto(c),c.init&&c.init()};d.prototype.createNewInstance=
function(a,b,c){console.log("createNewInstance",a,b);var d=this.factoryRegistry.get(a);console.log("factory",d);var e;d?d.fromJSON?e=d.fromJSON(b):d.fromModel?e=d.fromModel(b):console.error("ERROR: no factory method found!"):c&&(console.warn("no factory found! ",a),e=new a);return e};d.prototype.registerView=function(a,b){if(!this.mediatorsByViewInstance.get(a)){console.log("register view "+a);var c=this.viewMediatorMap.getMediatorClassForViewInstance(a);if(c==null)console.log("WARNING: no Mediator defined");
else{var c=new c,d=this.injector.getChild();for(field in a.on)d.mapValue(m.Signal,field,a.on[field]);d.injectInto(c);this.mediatorsByViewInstance.set(a,c);this.viewInstanceByMediator.set(c,a);this.controllerDataByView.set(a,b);c.map()}}};d.prototype.unregisterView=function(a){var b=this.mediatorsByViewInstance.get(a);b?b.unmap():console.log("no mediator found for "+a)};d.prototype.mapViewMediator=function(a,b){this.injector.mapInjectionFields(b);this.viewMediatorMap.mapView(a,b)};d.prototype.unmapViewMediator=
function(a,b){this.viewMediatorMap.unmapView(a,b)};d.prototype.mapSignal=function(a,b,c){if(a){this.injector.mapInjectionFields(b);var d;c&&(c=this.viewInstanceByMediator.get(c))&&(d=this.controllerDataByView.get(c));var g=this,c=function(a){var c=new b,e=g.injector.getChild(),f;for(f in a)console.log("signalData ",f,a[f]),console.log("CommandClass",b),e.mapValue(a[f].constructor,f,a[f]);for(f in d)console.log("controllerData ",f,d[f]),e.mapValue(d[f].constructor,f,d[f]);e.injectInto(c);c.execute()},
h=this.commandsBySignal.get(a);h||(h=new e,this.commandsBySignal.set(a,h));h.set(b,c);a.add(c)}else console.warn("View does not publish this signal Instance")};d.prototype.unmapSignal=function(a,b){var c=this.commandsBySignal.get(a);c&&(c=c.get(b))&&a.remove(c)};d.prototype.setContextView=function(a){this.contextView=a};return d});